<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
<title>html2jade.js</title>
<link rel="stylesheet" type="text/css" href="highlight.css">
</head>
<body class="hl">
<pre class="hl"><span class="hl slc">// Generated by CoffeeScript 1.3.3</span>
<span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">() {</span>
  <span class="hl kwa">var</span> Converter<span class="hl opt">,</span> Output<span class="hl opt">,</span> Parser<span class="hl opt">,</span> StreamOutput<span class="hl opt">,</span> StringOutput<span class="hl opt">,</span> Writer<span class="hl opt">,</span> publicIdDocTypeNames<span class="hl opt">,</span> scope<span class="hl opt">,</span> systemIdDocTypeNames<span class="hl opt">,</span> _ref<span class="hl opt">,</span>
    __hasProp <span class="hl opt">= {}.</span>hasOwnProperty<span class="hl opt">,</span>
    __extends <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">,</span> parent<span class="hl opt">) {</span> <span class="hl kwa">for</span> <span class="hl opt">(</span><span class="hl kwa">var</span> key <span class="hl kwa">in</span> parent<span class="hl opt">) {</span> <span class="hl kwa">if</span> <span class="hl opt">(</span>__hasProp<span class="hl opt">.</span><span class="hl kwd">call</span><span class="hl opt">(</span>parent<span class="hl opt">,</span> key<span class="hl opt">))</span> child<span class="hl kwc">[key]</span> <span class="hl opt">=</span> parent<span class="hl kwc">[key]</span><span class="hl opt">; }</span> <span class="hl kwa">function</span> <span class="hl kwd">ctor</span><span class="hl opt">() {</span> <span class="hl kwa">this</span><span class="hl opt">.</span>constructor <span class="hl opt">=</span> child<span class="hl opt">; }</span> ctor<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span> child<span class="hl opt">.</span><span class="hl kwa">prototype</span> <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ctor</span><span class="hl opt">();</span> child<span class="hl opt">.</span>__super__ <span class="hl opt">=</span> parent<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">;</span> <span class="hl kwa">return</span> child<span class="hl opt">; };</span>

  scope <span class="hl opt">=</span> <span class="hl kwa">typeof</span> exports <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span> exports <span class="hl opt">!==</span> <span class="hl kwa">null</span> ? exports <span class="hl opt">: (</span>_ref <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Html2Jade<span class="hl opt">) !=</span> <span class="hl kwa">null</span> ? _ref <span class="hl opt">:</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Html2Jade <span class="hl opt">= {};</span>

  Parser <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>

    <span class="hl kwa">function</span> <span class="hl kwd">Parser</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        options <span class="hl opt">= {};</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>jsdom <span class="hl opt">=</span> <span class="hl kwd">require</span><span class="hl opt">(</span><span class="hl str">'jsdom'</span><span class="hl opt">);</span>
    <span class="hl opt">}</span>

    Parser<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>parse <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>arg<span class="hl opt">,</span> cb<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>arg<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl kwd">cb</span><span class="hl opt">(</span><span class="hl str">'null file'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>jsdom<span class="hl opt">.</span><span class="hl kwd">env</span><span class="hl opt">(</span>arg<span class="hl opt">,</span> cb<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return</span> Parser<span class="hl opt">;</span>

  <span class="hl opt">})();</span>

  Writer <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>

    <span class="hl kwa">function</span> <span class="hl kwd">Writer</span><span class="hl opt">(</span>options<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> _ref1<span class="hl opt">,</span> _ref2<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        options <span class="hl opt">= {};</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>wrapLength <span class="hl opt">= (</span>_ref1 <span class="hl opt">=</span> options<span class="hl opt">.</span>wrapLength<span class="hl opt">) !=</span> <span class="hl kwa">null</span> ? _ref1 <span class="hl opt">:</span> <span class="hl num">80</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>scalate <span class="hl opt">= (</span>_ref2 <span class="hl opt">=</span> options<span class="hl opt">.</span>scalate<span class="hl opt">) !=</span> <span class="hl kwa">null</span> ? _ref2 <span class="hl opt">:</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>attrSep <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>scalate ? <span class="hl str">' '</span> <span class="hl opt">:</span> <span class="hl str">', '</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    Writer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>tagHead <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> classes<span class="hl opt">,</span> result<span class="hl opt">;</span>
      result <span class="hl opt">=</span> node<span class="hl opt">.</span>tagName <span class="hl opt">!==</span> <span class="hl str">'DIV'</span> ? node<span class="hl opt">.</span>tagName<span class="hl opt">.</span><span class="hl kwd">toLowerCase</span><span class="hl opt">() :</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>node<span class="hl opt">.</span>id<span class="hl opt">) {</span>
        result <span class="hl opt">+=</span> <span class="hl str">'#'</span> <span class="hl opt">+</span> node<span class="hl opt">.</span>id<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>node<span class="hl opt">.</span><span class="hl kwd">hasAttribute</span><span class="hl opt">(</span><span class="hl str">'class'</span><span class="hl opt">) &amp;&amp;</span> node<span class="hl opt">.</span><span class="hl kwd">getAttribute</span><span class="hl opt">(</span><span class="hl str">'class'</span><span class="hl opt">).</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        classes <span class="hl opt">=</span> node<span class="hl opt">.</span><span class="hl kwd">getAttribute</span><span class="hl opt">(</span><span class="hl str">'class'</span><span class="hl opt">).</span><span class="hl kwd">split</span><span class="hl opt">(/</span>\s<span class="hl opt">+/).</span><span class="hl kwd">filter</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>item<span class="hl opt">) {</span>
          <span class="hl kwa">return</span> <span class="hl opt">(</span>item <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">) &amp;&amp;</span> item<span class="hl opt">.</span><span class="hl kwd">trim</span><span class="hl opt">().</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">;</span>
        <span class="hl opt">});</span>
        result <span class="hl opt">+=</span> <span class="hl str">'.'</span> <span class="hl opt">+</span> classes<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">'.'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>result<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        result <span class="hl opt">=</span> <span class="hl str">'div'</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> result<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Writer<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>tagAttr <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> attr<span class="hl opt">,</span> attrs<span class="hl opt">,</span> nodeName<span class="hl opt">,</span> result<span class="hl opt">,</span> _i<span class="hl opt">,</span> _len<span class="hl opt">;</span>
      attrs <span class="hl opt">=</span> node<span class="hl opt">.</span>attributes<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>attrs || attrs<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        result <span class="hl opt">= [];</span>
        <span class="hl kwa">for</span> <span class="hl opt">(</span>_i <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">,</span> _len <span class="hl opt">=</span> attrs<span class="hl opt">.</span>length<span class="hl opt">;</span> _i <span class="hl opt">&lt;</span> _len<span class="hl opt">;</span> _i<span class="hl opt">++) {</span>
          attr <span class="hl opt">=</span> attrs<span class="hl kwc">[_i]</span><span class="hl opt">;</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>attr <span class="hl opt">&amp;&amp; (</span>nodeName <span class="hl opt">=</span> attr<span class="hl opt">.</span>nodeName<span class="hl opt">)) {</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>nodeName <span class="hl opt">!==</span> <span class="hl str">'id'</span> <span class="hl opt">&amp;&amp;</span> nodeName <span class="hl opt">!==</span> <span class="hl str">'class'</span> <span class="hl opt">&amp;&amp;</span> <span class="hl kwa">typeof</span> <span class="hl opt">(</span>attr<span class="hl opt">.</span>nodeValue <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)) {</span>
              result<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>attr<span class="hl opt">.</span>nodeName <span class="hl opt">+</span> <span class="hl str">'=</span><span class="hl esc">\'</span><span class="hl str">'</span> <span class="hl opt">+</span> attr<span class="hl opt">.</span>nodeValue<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(/</span><span class="hl str">'/g, '</span><span class="hl esc">\\\'</span><span class="hl str">') + '</span><span class="hl esc">\'</span><span class="hl str">');</span>
<span class="hl str">            }</span>
<span class="hl str">          }</span>
<span class="hl str">        }</span>
<span class="hl str">        if (result.length &gt; 0) {</span>
<span class="hl str">          return '</span><span class="hl opt">(</span><span class="hl str">' + result.join(this.attrSep) + '</span><span class="hl opt">)</span><span class="hl str">';</span>
<span class="hl str">        } else {</span>
<span class="hl str">          return '</span><span class="hl str">';</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.tagText = function(node) {</span>
<span class="hl str">      var data, _ref1;</span>
<span class="hl str">      if (((_ref1 = node.firstChild) != null ? _ref1.nodeType : void 0) !== 3) {</span>
<span class="hl str">        return null;</span>
<span class="hl str">      } else if (node.firstChild !== node.lastChild) {</span>
<span class="hl str">        return null;</span>
<span class="hl str">      } else {</span>
<span class="hl str">        data = node.firstChild.data;</span>
<span class="hl str">        if (data.length &gt; this.wrapLength || data.match(/</span><span class="hl esc">\r</span><span class="hl str">|</span><span class="hl esc">\n</span><span class="hl str">/)) {</span>
<span class="hl str">          return null;</span>
<span class="hl str">        } else {</span>
<span class="hl str">          return data;</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.forEachChild = function(parent, cb) {</span>
<span class="hl str">      var child, _results;</span>
<span class="hl str">      if (parent) {</span>
<span class="hl str">        child = parent.firstChild;</span>
<span class="hl str">        _results = [];</span>
<span class="hl str">        while (child) {</span>
<span class="hl str">          cb(child);</span>
<span class="hl str">          _results.push(child = child.nextSibling);</span>
<span class="hl str">        }</span>
<span class="hl str">        return _results;</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.writeTextContent = function(node, output, pipe, trim, wrap, escapeBackslash) {</span>
<span class="hl str">      var _this = this;</span>
<span class="hl str">      if (pipe == null) {</span>
<span class="hl str">        pipe = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (trim == null) {</span>
<span class="hl str">        trim = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (wrap == null) {</span>
<span class="hl str">        wrap = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (escapeBackslash == null) {</span>
<span class="hl str">        escapeBackslash = false;</span>
<span class="hl str">      }</span>
<span class="hl str">      output.enter();</span>
<span class="hl str">      this.forEachChild(node, function(child) {</span>
<span class="hl str">        return _this.writeText(child, output, pipe, trim, wrap, escapeBackslash);</span>
<span class="hl str">      });</span>
<span class="hl str">      return output.leave();</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.writeText = function(node, output, pipe, trim, wrap, escapeBackslash) {</span>
<span class="hl str">      var data, lines,</span>
<span class="hl str">        _this = this;</span>
<span class="hl str">      if (pipe == null) {</span>
<span class="hl str">        pipe = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (trim == null) {</span>
<span class="hl str">        trim = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (wrap == null) {</span>
<span class="hl str">        wrap = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (escapeBackslash == null) {</span>
<span class="hl str">        escapeBackslash = false;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (node.nodeType === 3) {</span>
<span class="hl str">        data = node.data || '</span><span class="hl str">';</span>
<span class="hl str">        if (data.length &gt; 0) {</span>
<span class="hl str">          lines = data.split(/</span><span class="hl esc">\r</span><span class="hl str">|</span><span class="hl esc">\n</span><span class="hl str">/);</span>
<span class="hl str">          return lines.forEach(function(line) {</span>
<span class="hl str">            return _this.writeTextLine(line, output, pipe, trim, wrap, escapeBackslash);</span>
<span class="hl str">          });</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.writeTextLine = function(line, output, pipe, trim, wrap, escapeBackslash) {</span>
<span class="hl str">      var lines, prefix,</span>
<span class="hl str">        _this = this;</span>
<span class="hl str">      if (pipe == null) {</span>
<span class="hl str">        pipe = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (trim == null) {</span>
<span class="hl str">        trim = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (wrap == null) {</span>
<span class="hl str">        wrap = true;</span>
<span class="hl str">      }</span>
<span class="hl str">      if (escapeBackslash == null) {</span>
<span class="hl str">        escapeBackslash = false;</span>
<span class="hl str">      }</span>
<span class="hl str">      prefix = pipe ? '</span>| <span class="hl str">' : '</span><span class="hl str">';</span>
<span class="hl str">      if (trim) {</span>
<span class="hl str">        line = line ? line.trim() : '</span><span class="hl str">';</span>
<span class="hl str">      }</span>
<span class="hl str">      if (line &amp;&amp; line.length &gt; 0) {</span>
<span class="hl str">        if (escapeBackslash) {</span>
<span class="hl str">          line = line.replace(&quot;</span><span class="hl esc">\\</span><span class="hl str">&quot;, &quot;</span><span class="hl esc">\\\\</span><span class="hl str">&quot;);</span>
<span class="hl str">        }</span>
<span class="hl str">        if (!wrap || line.length &lt;= this.wrapLength) {</span>
<span class="hl str">          return output.writeln(prefix + line);</span>
<span class="hl str">        } else {</span>
<span class="hl str">          lines = this.breakLine(line);</span>
<span class="hl str">          if (lines.length === 1) {</span>
<span class="hl str">            return output.writeln(prefix + line);</span>
<span class="hl str">          } else {</span>
<span class="hl str">            return lines.forEach(function(line) {</span>
<span class="hl str">              return _this.writeTextLine(line, output, pipe, trim, wrap);</span>
<span class="hl str">            });</span>
<span class="hl str">          }</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Writer.prototype.breakLine = function(line) {</span>
<span class="hl str">      var lines, word, words;</span>
<span class="hl str">      if (!line || line.length === 0) {</span>
<span class="hl str">        return [];</span>
<span class="hl str">      }</span>
<span class="hl str">      if (line.search(/\s+/ === -1)) {</span>
<span class="hl str">        return [line];</span>
<span class="hl str">      }</span>
<span class="hl str">      lines = [];</span>
<span class="hl str">      words = line.split(/\s+/);</span>
<span class="hl str">      line = '</span><span class="hl str">';</span>
<span class="hl str">      while (words.length) {</span>
<span class="hl str">        word = words.shift();</span>
<span class="hl str">        if (line.length + word.length &gt; this.wrapLength) {</span>
<span class="hl str">          lines.push(line);</span>
<span class="hl str">          line = word;</span>
<span class="hl str">        } else if (line.length) {</span>
<span class="hl str">          line += '</span> <span class="hl str">' + word;</span>
<span class="hl str">        } else {</span>
<span class="hl str">          line = word;</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">      if (line.length) {</span>
<span class="hl str">        lines.push(line);</span>
<span class="hl str">      }</span>
<span class="hl str">      return lines;</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    return Writer;</span>
<span class="hl str"></span>
<span class="hl str">  })();</span>
<span class="hl str"></span>
<span class="hl str">  publicIdDocTypeNames = {</span>
<span class="hl str">    &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;: &quot;transitional&quot;,</span>
<span class="hl str">    &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot;: &quot;strict&quot;,</span>
<span class="hl str">    &quot;-//W3C//DTD XHTML 1.0 Frameset//EN&quot;: &quot;frameset&quot;,</span>
<span class="hl str">    &quot;-//W3C//DTD XHTML 1.1//EN&quot;: &quot;1.1&quot;,</span>
<span class="hl str">    &quot;-//W3C//DTD XHTML Basic 1.1//EN&quot;: &quot;basic&quot;,</span>
<span class="hl str">    &quot;-//WAPFORUM//DTD XHTML Mobile 1.2//EN&quot;: &quot;mobile&quot;</span>
<span class="hl str">  };</span>
<span class="hl str"></span>
<span class="hl str">  systemIdDocTypeNames = {</span>
<span class="hl str">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;: &quot;transitional&quot;,</span>
<span class="hl str">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;: &quot;strict&quot;,</span>
<span class="hl str">    &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-frameset.dtd&quot;: &quot;frameset&quot;,</span>
<span class="hl str">    &quot;http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd&quot;: &quot;1.1&quot;,</span>
<span class="hl str">    &quot;http://www.w3.org/TR/xhtml-basic/xhtml-basic11.dtd&quot;: &quot;basic&quot;,</span>
<span class="hl str">    &quot;http://www.openmobilealliance.org/tech/DTD/xhtml-mobile12.dtd&quot;: &quot;mobile&quot;</span>
<span class="hl str">  };</span>
<span class="hl str"></span>
<span class="hl str">  Converter = (function() {</span>
<span class="hl str"></span>
<span class="hl str">    function Converter(options) {</span>
<span class="hl str">      var _ref1, _ref2;</span>
<span class="hl str">      if (options == null) {</span>
<span class="hl str">        options = {};</span>
<span class="hl str">      }</span>
<span class="hl str">      this.scalate = (_ref1 = options.scalate) != null ? _ref1 : false;</span>
<span class="hl str">      this.writer = (_ref2 = options.writer) != null ? _ref2 : new Writer(options);</span>
<span class="hl str">    }</span>
<span class="hl str"></span>
<span class="hl str">    Converter.prototype.document = function(document, output) {</span>
<span class="hl str">      var docTypeName, doctype, htmlEls, publicId, systemId;</span>
<span class="hl str">      if (document.doctype != null) {</span>
<span class="hl str">        doctype = document.doctype;</span>
<span class="hl str">        docTypeName = void 0;</span>
<span class="hl str">        publicId = doctype.publicId;</span>
<span class="hl str">        systemId = doctype.systemId;</span>
<span class="hl str">        if ((publicId != null) &amp;&amp; (publicIdDocTypeNames[publicId] != null)) {</span>
<span class="hl str">          docTypeName = publicIdDocTypeNames[publicId];</span>
<span class="hl str">        } else if ((systemId != null) &amp;&amp; (systemIdDocTypeNames[systemId] != null)) {</span>
<span class="hl str">          docTypeName = systemIdDocTypeNames[systemId] != null;</span>
<span class="hl str">        } else if ((doctype.name != null) &amp;&amp; doctype.name.toLowerCase() === '</span>html<span class="hl str">') {</span>
<span class="hl str">          docTypeName = '</span><span class="hl num">5</span><span class="hl str">';</span>
<span class="hl str">        }</span>
<span class="hl str">        if (docTypeName != null) {</span>
<span class="hl str">          output.writeln('</span><span class="hl opt">!!!</span> <span class="hl str">' + docTypeName);</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">      if (document.documentElement) {</span>
<span class="hl str">        return this.children(document, output, false);</span>
<span class="hl str">      } else {</span>
<span class="hl str">        htmlEls = document.getElementsByTagName('</span>html<span class="hl str">');</span>
<span class="hl str">        if (htmlEls.length &gt; 0) {</span>
<span class="hl str">          return this.element(htmlEls[0], output);</span>
<span class="hl str">        }</span>
<span class="hl str">      }</span>
<span class="hl str">    };</span>
<span class="hl str"></span>
<span class="hl str">    Converter.prototype.element = function(node, output) {</span>
<span class="hl str">      var firstline, tagAttr, tagHead, tagName, tagText,</span>
<span class="hl str">        _this = this;</span>
<span class="hl str">      if (!(node != null ? node.tagName : void 0)) {</span>
<span class="hl str">        return;</span>
<span class="hl str">      }</span>
<span class="hl str">      tagName = node.tagName.toLowerCase();</span>
<span class="hl str">      tagHead = this.writer.tagHead(node);</span>
<span class="hl str">      tagAttr = this.writer.tagAttr(node);</span>
<span class="hl str">      tagText = this.writer.tagText(node);</span>
<span class="hl str">      if (tagName === '</span>script<span class="hl str">' || tagName === '</span>style<span class="hl str">') {</span>
<span class="hl str">        if (node.hasAttribute('</span>src<span class="hl str">')) {</span>
<span class="hl str">          output.writeln(tagHead + tagAttr);</span>
<span class="hl str">          return this.writer.writeTextContent(node, output, false, false, false);</span>
<span class="hl str">        } else if (tagName === '</span>script<span class="hl str">') {</span>
<span class="hl str">          return this.script(node, output, tagHead, tagAttr);</span>
<span class="hl str">        } else if (tagName === '</span>style<span class="hl str">') {</span>
<span class="hl str">          return this.style(node, output, tagHead, tagAttr);</span>
<span class="hl str">        }</span>
<span class="hl str">      } else if (tagName === '</span>conditional<span class="hl str">') {</span>
<span class="hl str">        output.writeln('</span><span class="hl slc">//' + node.getAttribute('condition'));</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">children</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">([</span><span class="hl str">'pre'</span><span class="hl opt">].</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span>tagName<span class="hl opt">) !== -</span><span class="hl num">1</span><span class="hl opt">) {</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span>tagHead <span class="hl opt">+</span> tagAttr <span class="hl opt">+</span> <span class="hl str">'.'</span><span class="hl opt">);</span>
        output<span class="hl opt">.</span><span class="hl kwd">enter</span><span class="hl opt">();</span>
        firstline <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
        <span class="hl kwa">this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">forEachChild</span><span class="hl opt">(</span>node<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
          <span class="hl kwa">var</span> data<span class="hl opt">;</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>child<span class="hl opt">.</span>nodeType <span class="hl opt">===</span> <span class="hl num">3</span><span class="hl opt">) {</span>
            data <span class="hl opt">=</span> child<span class="hl opt">.</span>data<span class="hl opt">;</span>
            <span class="hl kwa">if</span> <span class="hl opt">((</span>data <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">) &amp;&amp;</span> data<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span><span class="hl opt">) {</span>
              <span class="hl kwa">if</span> <span class="hl opt">(</span>firstline<span class="hl opt">) {</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>data<span class="hl opt">.</span><span class="hl kwd">search</span><span class="hl opt">(/</span><span class="hl esc">\r\n</span>|<span class="hl esc">\r</span>|<span class="hl esc">\n</span><span class="hl opt">/) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
                  data <span class="hl opt">=</span> data<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(/</span><span class="hl esc">\r\n</span>|<span class="hl esc">\r</span>|<span class="hl esc">\n</span><span class="hl opt">/,</span> <span class="hl str">''</span><span class="hl opt">);</span>
                <span class="hl opt">}</span>
                data <span class="hl opt">=</span> <span class="hl str">'</span><span class="hl esc">\\</span><span class="hl str">n'</span> <span class="hl opt">+</span> data<span class="hl opt">;</span>
                firstline <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
              <span class="hl opt">}</span>
              data <span class="hl opt">=</span> data<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(/</span><span class="hl esc">\t</span><span class="hl opt">/</span>g<span class="hl opt">,</span> <span class="hl str">'</span><span class="hl esc">\\</span><span class="hl str">t'</span><span class="hl opt">);</span>
              data <span class="hl opt">=</span> data<span class="hl opt">.</span><span class="hl kwd">replace</span><span class="hl opt">(/</span><span class="hl esc">\r\n</span>|<span class="hl esc">\r</span>|<span class="hl esc">\n</span><span class="hl opt">/</span>g<span class="hl opt">,</span> <span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span> <span class="hl opt">+</span> output<span class="hl opt">.</span>indents<span class="hl opt">);</span>
              <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
            <span class="hl opt">}</span>
          <span class="hl opt">}</span>
        <span class="hl opt">});</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">();</span>
        <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">leave</span><span class="hl opt">();</span>
      <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>tagText<span class="hl opt">) {</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>tagText<span class="hl opt">.</span>length <span class="hl opt">&gt;</span> <span class="hl num">0</span> <span class="hl opt">&amp;&amp;</span> tagText<span class="hl opt">.</span><span class="hl kwd">charAt</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">) ===</span> <span class="hl str">'='</span><span class="hl opt">) {</span>
          tagText <span class="hl opt">=</span> <span class="hl str">'</span><span class="hl esc">\\</span><span class="hl str">'</span> <span class="hl opt">+</span> tagText<span class="hl opt">;</span>
        <span class="hl opt">}</span>
        <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span>tagHead <span class="hl opt">+</span> tagAttr <span class="hl opt">+</span> <span class="hl str">' '</span> <span class="hl opt">+</span> tagText<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span>tagHead <span class="hl opt">+</span> tagAttr<span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">children</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>children <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>parent<span class="hl opt">,</span> output<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> _this <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        output<span class="hl opt">.</span><span class="hl kwd">enter</span><span class="hl opt">();</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">forEachChild</span><span class="hl opt">(</span>parent<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>child<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> nodeType<span class="hl opt">;</span>
        nodeType <span class="hl opt">=</span> child<span class="hl opt">.</span>nodeType<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>nodeType <span class="hl opt">===</span> <span class="hl num">1</span><span class="hl opt">) {</span>
          <span class="hl kwa">return</span> _this<span class="hl opt">.</span><span class="hl kwd">element</span><span class="hl opt">(</span>child<span class="hl opt">,</span> output<span class="hl opt">);</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>nodeType <span class="hl opt">===</span> <span class="hl num">3</span><span class="hl opt">) {</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>parent<span class="hl opt">.</span>_nodeName <span class="hl opt">===</span> <span class="hl str">'code'</span><span class="hl opt">) {</span>
            <span class="hl kwa">return</span> _this<span class="hl opt">.</span><span class="hl kwd">text</span><span class="hl opt">(</span>child<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
          <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
            <span class="hl kwa">return</span> _this<span class="hl opt">.</span><span class="hl kwd">text</span><span class="hl opt">(</span>child<span class="hl opt">,</span> output<span class="hl opt">);</span>
          <span class="hl opt">}</span>
        <span class="hl opt">}</span> <span class="hl kwa">else if</span> <span class="hl opt">(</span>nodeType <span class="hl opt">===</span> <span class="hl num">8</span><span class="hl opt">) {</span>
          <span class="hl kwa">return</span> _this<span class="hl opt">.</span><span class="hl kwd">comment</span><span class="hl opt">(</span>child<span class="hl opt">,</span> output<span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">});</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">leave</span><span class="hl opt">();</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>text <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> pipe<span class="hl opt">,</span> trim<span class="hl opt">,</span> wrap<span class="hl opt">) {</span>
      node<span class="hl opt">.</span><span class="hl kwd">normalize</span><span class="hl opt">();</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeText</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> pipe<span class="hl opt">,</span> trim<span class="hl opt">,</span> wrap<span class="hl opt">);</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>comment <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> condition<span class="hl opt">,</span> data<span class="hl opt">,</span> lines<span class="hl opt">,</span>
        _this <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">;</span>
      condition <span class="hl opt">=</span> node<span class="hl opt">.</span>data<span class="hl opt">.</span><span class="hl kwd">match</span><span class="hl opt">(/</span>\s<span class="hl opt">*</span>\<span class="hl opt">[(</span><span class="hl kwa">if</span>\s<span class="hl opt">+[</span>^\<span class="hl opt">]]+)</span>\<span class="hl opt">]/);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(!</span>condition<span class="hl opt">) {</span>
        data <span class="hl opt">=</span> node<span class="hl opt">.</span>data || <span class="hl str">''</span><span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>data<span class="hl opt">.</span>length <span class="hl opt">===</span> <span class="hl num">0</span> || data<span class="hl opt">.</span><span class="hl kwd">search</span><span class="hl opt">(/</span><span class="hl esc">\r</span>|<span class="hl esc">\n</span><span class="hl opt">/) === -</span><span class="hl num">1</span><span class="hl opt">) {</span>
          <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">&quot;// &quot;</span> <span class="hl opt">+ (</span>data<span class="hl opt">.</span><span class="hl kwd">trim</span><span class="hl opt">()));</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">'//'</span><span class="hl opt">);</span>
          output<span class="hl opt">.</span><span class="hl kwd">enter</span><span class="hl opt">();</span>
          lines <span class="hl opt">=</span> data<span class="hl opt">.</span><span class="hl kwd">split</span><span class="hl opt">(/</span><span class="hl esc">\r</span>|<span class="hl esc">\n</span><span class="hl opt">/);</span>
          lines<span class="hl opt">.</span><span class="hl kwd">forEach</span><span class="hl opt">(</span><span class="hl kwa">function</span><span class="hl opt">(</span>line<span class="hl opt">) {</span>
            <span class="hl kwa">return</span> _this<span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeTextLine</span><span class="hl opt">(</span>line<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
          <span class="hl opt">});</span>
          <span class="hl kwa">return</span> output<span class="hl opt">.</span><span class="hl kwd">leave</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span><span class="hl kwd">conditional</span><span class="hl opt">(</span>node<span class="hl opt">,</span> condition<span class="hl kwc">[1]</span><span class="hl opt">,</span> output<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>conditional <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">,</span> condition<span class="hl opt">,</span> output<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> conditionalElem<span class="hl opt">,</span> innerHTML<span class="hl opt">;</span>
      innerHTML <span class="hl opt">=</span> node<span class="hl opt">.</span>textContent<span class="hl opt">.</span><span class="hl kwd">trim</span><span class="hl opt">().</span><span class="hl kwd">replace</span><span class="hl opt">(/</span>\s<span class="hl opt">*</span>\<span class="hl opt">[</span><span class="hl kwa">if</span>\s<span class="hl opt">+[</span>^\<span class="hl opt">]]+</span>\<span class="hl opt">]&gt;</span>\s*/<span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">).</span><span class="hl kwd">replace</span><span class="hl opt">(</span><span class="hl str">'&lt;![endif]'</span><span class="hl opt">,</span> <span class="hl str">''</span><span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>innerHTML<span class="hl opt">.</span><span class="hl kwd">indexOf</span><span class="hl opt">(</span><span class="hl str">&quot;&lt;!&quot;</span><span class="hl opt">) ===</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        condition <span class="hl opt">=</span> <span class="hl str">&quot; [&quot;</span> <span class="hl opt">+</span> condition <span class="hl opt">+</span> <span class="hl str">&quot;] &lt;!&quot;</span><span class="hl opt">;</span>
        innerHTML <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      conditionalElem <span class="hl opt">=</span> node<span class="hl opt">.</span>ownerDocument<span class="hl opt">.</span><span class="hl kwd">createElement</span><span class="hl opt">(</span><span class="hl str">'conditional'</span><span class="hl opt">);</span>
      conditionalElem<span class="hl opt">.</span><span class="hl kwd">setAttribute</span><span class="hl opt">(</span><span class="hl str">'condition'</span><span class="hl opt">,</span> condition<span class="hl opt">);</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>innerHTML<span class="hl opt">) {</span>
        conditionalElem<span class="hl opt">.</span>innerHTML <span class="hl opt">=</span> innerHTML<span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> node<span class="hl opt">.</span>parentNode<span class="hl opt">.</span><span class="hl kwd">insertBefore</span><span class="hl opt">(</span>conditionalElem<span class="hl opt">,</span> node<span class="hl opt">.</span>nextSibling<span class="hl opt">);</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>script <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> tagHead<span class="hl opt">,</span> tagAttr<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>scalate<span class="hl opt">) {</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">':javascript'</span><span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeTextContent</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">&quot;&quot;</span> <span class="hl opt">+</span> tagHead <span class="hl opt">+</span> tagAttr<span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeTextContent</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Converter<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>style <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> tagHead<span class="hl opt">,</span> tagAttr<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>scalate<span class="hl opt">) {</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">':css'</span><span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeTextContent</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        output<span class="hl opt">.</span><span class="hl kwd">writeln</span><span class="hl opt">(</span><span class="hl str">&quot;&quot;</span> <span class="hl opt">+</span> tagHead <span class="hl opt">+</span> tagAttr<span class="hl opt">);</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>writer<span class="hl opt">.</span><span class="hl kwd">writeTextContent</span><span class="hl opt">(</span>node<span class="hl opt">,</span> output<span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">,</span> <span class="hl kwa">false</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return</span> Converter<span class="hl opt">;</span>

  <span class="hl opt">})();</span>

  Output <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">() {</span>

    <span class="hl kwa">function</span> <span class="hl kwd">Output</span><span class="hl opt">() {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>indents <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
    <span class="hl opt">}</span>

    Output<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>enter <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>indents <span class="hl opt">+=</span> <span class="hl str">'  '</span><span class="hl opt">;</span>
    <span class="hl opt">};</span>

    Output<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>leave <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
      <span class="hl kwa">return this</span><span class="hl opt">.</span>indents <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>indents<span class="hl opt">.</span><span class="hl kwd">substring</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">);</span>
    <span class="hl opt">};</span>

    Output<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>write <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    Output<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>writeln <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return</span> Output<span class="hl opt">;</span>

  <span class="hl opt">})();</span>

  StringOutput <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">(</span>_super<span class="hl opt">) {</span>

    <span class="hl kwd">__extends</span><span class="hl opt">(</span>StringOutput<span class="hl opt">,</span> _super<span class="hl opt">);</span>

    <span class="hl kwa">function</span> <span class="hl kwd">StringOutput</span><span class="hl opt">() {</span>
      StringOutput<span class="hl opt">.</span>__super__<span class="hl opt">.</span>constructor<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>fragments <span class="hl opt">= [];</span>
    <span class="hl opt">}</span>

    StringOutput<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>write <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        data <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>fragments<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>indents <span class="hl opt">+</span> data<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>fragments<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    StringOutput<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>writeln <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        data <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>fragments<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>indents <span class="hl opt">+</span> data <span class="hl opt">+</span> <span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>fragments<span class="hl opt">.</span><span class="hl kwd">push</span><span class="hl opt">(</span>data <span class="hl opt">+</span> <span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    StringOutput<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>final <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">() {</span>
      <span class="hl kwa">var</span> result<span class="hl opt">;</span>
      result <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>fragments<span class="hl opt">.</span><span class="hl kwd">join</span><span class="hl opt">(</span><span class="hl str">''</span><span class="hl opt">);</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>fragments <span class="hl opt">= [];</span>
      <span class="hl kwa">return</span> result<span class="hl opt">;</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return</span> StringOutput<span class="hl opt">;</span>

  <span class="hl opt">})(</span>Output<span class="hl opt">);</span>

  StreamOutput <span class="hl opt">= (</span><span class="hl kwa">function</span><span class="hl opt">(</span>_super<span class="hl opt">) {</span>

    <span class="hl kwd">__extends</span><span class="hl opt">(</span>StreamOutput<span class="hl opt">,</span> _super<span class="hl opt">);</span>

    <span class="hl kwa">function</span> <span class="hl kwd">StreamOutput</span><span class="hl opt">(</span>stream<span class="hl opt">) {</span>
      <span class="hl kwa">this</span><span class="hl opt">.</span>stream <span class="hl opt">=</span> stream<span class="hl opt">;</span>
      StreamOutput<span class="hl opt">.</span>__super__<span class="hl opt">.</span>constructor<span class="hl opt">.</span><span class="hl kwd">apply</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">,</span> arguments<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    StreamOutput<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>write <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        data <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>stream<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>indents <span class="hl opt">+</span> data<span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>stream<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>data<span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    StreamOutput<span class="hl opt">.</span><span class="hl kwa">prototype</span><span class="hl opt">.</span>writeln <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>data<span class="hl opt">,</span> indent<span class="hl opt">) {</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        indent <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        data <span class="hl opt">=</span> <span class="hl str">''</span><span class="hl opt">;</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>indent<span class="hl opt">) {</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>stream<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">.</span>indents <span class="hl opt">+</span> data <span class="hl opt">+</span> <span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        <span class="hl kwa">return this</span><span class="hl opt">.</span>stream<span class="hl opt">.</span><span class="hl kwd">write</span><span class="hl opt">(</span>data <span class="hl opt">+</span> <span class="hl str">'</span><span class="hl esc">\n</span><span class="hl str">'</span><span class="hl opt">);</span>
      <span class="hl opt">}</span>
    <span class="hl opt">};</span>

    <span class="hl kwa">return</span> StreamOutput<span class="hl opt">;</span>

  <span class="hl opt">})(</span>Output<span class="hl opt">);</span>

  scope<span class="hl opt">.</span>Output <span class="hl opt">=</span> Output<span class="hl opt">;</span>

  scope<span class="hl opt">.</span>StringOutput <span class="hl opt">=</span> StringOutput<span class="hl opt">;</span>

  scope<span class="hl opt">.</span>Converter <span class="hl opt">=</span> Converter<span class="hl opt">;</span>

  scope<span class="hl opt">.</span>Writer <span class="hl opt">=</span> Writer<span class="hl opt">;</span>

  <span class="hl kwa">if</span> <span class="hl opt">(</span><span class="hl kwa">typeof</span> exports <span class="hl opt">!==</span> <span class="hl str">&quot;undefined&quot;</span> <span class="hl opt">&amp;&amp;</span> exports <span class="hl opt">!==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
    scope<span class="hl opt">.</span>Parser <span class="hl opt">=</span> Parser<span class="hl opt">;</span>
    scope<span class="hl opt">.</span>StreamOutput <span class="hl opt">=</span> StreamOutput<span class="hl opt">;</span>
    scope<span class="hl opt">.</span>convert <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>input<span class="hl opt">,</span> output<span class="hl opt">,</span> options<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> _ref1<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        options <span class="hl opt">= {};</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">if</span> <span class="hl opt">((</span>_ref1 <span class="hl opt">=</span> options<span class="hl opt">.</span>parser<span class="hl opt">) ==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
        options<span class="hl opt">.</span>parser <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Parser</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
      <span class="hl opt">}</span>
      <span class="hl kwa">return</span> options<span class="hl opt">.</span>parser<span class="hl opt">.</span><span class="hl kwd">parse</span><span class="hl opt">(</span>input<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>errors<span class="hl opt">,</span> window<span class="hl opt">) {</span>
        <span class="hl kwa">var</span> _ref2<span class="hl opt">;</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>errors <span class="hl opt">!=</span> <span class="hl kwa">null</span> ? errors<span class="hl opt">.</span>length <span class="hl opt">:</span> <span class="hl kwa">void</span> <span class="hl num">0</span><span class="hl opt">) {</span>
          <span class="hl kwa">return</span> errors<span class="hl opt">;</span>
        <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
          <span class="hl kwa">if</span> <span class="hl opt">(</span>output <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
            output <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">StreamOutput</span><span class="hl opt">(</span>process<span class="hl opt">.</span>stdout<span class="hl opt">);</span>
          <span class="hl opt">}</span>
          <span class="hl kwa">if</span> <span class="hl opt">((</span>_ref2 <span class="hl opt">=</span> options<span class="hl opt">.</span>converter<span class="hl opt">) ==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
            options<span class="hl opt">.</span>converter <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Converter</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
          <span class="hl opt">}</span>
          <span class="hl kwa">return</span> options<span class="hl opt">.</span>converter<span class="hl opt">.</span><span class="hl kwd">document</span><span class="hl opt">(</span>window<span class="hl opt">.</span>document<span class="hl opt">,</span> output<span class="hl opt">);</span>
        <span class="hl opt">}</span>
      <span class="hl opt">});</span>
    <span class="hl opt">};</span>
  <span class="hl opt">}</span>

  scope<span class="hl opt">.</span>convertHtml <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>html<span class="hl opt">,</span> options<span class="hl opt">,</span> cb<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> _ref1<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      options <span class="hl opt">= {};</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>_ref1 <span class="hl opt">=</span> options<span class="hl opt">.</span>parser<span class="hl opt">) ==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      options<span class="hl opt">.</span>parser <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Parser</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    <span class="hl kwa">return</span> options<span class="hl opt">.</span>parser<span class="hl opt">.</span><span class="hl kwd">parse</span><span class="hl opt">(</span>html<span class="hl opt">,</span> <span class="hl kwa">function</span><span class="hl opt">(</span>errors<span class="hl opt">,</span> window<span class="hl opt">) {</span>
      <span class="hl kwa">var</span> output<span class="hl opt">,</span> _ref2<span class="hl opt">,</span> _ref3<span class="hl opt">;</span>
      <span class="hl kwa">if</span> <span class="hl opt">(</span>errors <span class="hl opt">!=</span> <span class="hl kwa">null</span> ? errors<span class="hl opt">.</span>length <span class="hl opt">:</span> <span class="hl kwa">void</span> <span class="hl num">0</span><span class="hl opt">) {</span>
        <span class="hl kwa">return</span> errors<span class="hl opt">;</span>
      <span class="hl opt">}</span> <span class="hl kwa">else</span> <span class="hl opt">{</span>
        output <span class="hl opt">= (</span>_ref2 <span class="hl opt">=</span> options<span class="hl opt">.</span>output<span class="hl opt">) !=</span> <span class="hl kwa">null</span> ? _ref2 <span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">StringOutput</span><span class="hl opt">();</span>
        <span class="hl kwa">if</span> <span class="hl opt">((</span>_ref3 <span class="hl opt">=</span> options<span class="hl opt">.</span>converter<span class="hl opt">) ==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
          options<span class="hl opt">.</span>converter <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Converter</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
        <span class="hl opt">}</span>
        options<span class="hl opt">.</span>converter<span class="hl opt">.</span><span class="hl kwd">document</span><span class="hl opt">(</span>window<span class="hl opt">.</span>document<span class="hl opt">,</span> output<span class="hl opt">);</span>
        <span class="hl kwa">if</span> <span class="hl opt">(</span>cb <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
          <span class="hl kwa">return</span> <span class="hl kwd">cb</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> output<span class="hl opt">.</span><span class="hl kwd">final</span><span class="hl opt">());</span>
        <span class="hl opt">}</span>
      <span class="hl opt">}</span>
    <span class="hl opt">});</span>
  <span class="hl opt">};</span>

  scope<span class="hl opt">.</span>convertDocument <span class="hl opt">=</span> <span class="hl kwa">function</span><span class="hl opt">(</span>document<span class="hl opt">,</span> options<span class="hl opt">,</span> cb<span class="hl opt">) {</span>
    <span class="hl kwa">var</span> output<span class="hl opt">,</span> _ref1<span class="hl opt">,</span> _ref2<span class="hl opt">;</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>options <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      options <span class="hl opt">= {};</span>
    <span class="hl opt">}</span>
    output <span class="hl opt">= (</span>_ref1 <span class="hl opt">=</span> options<span class="hl opt">.</span>output<span class="hl opt">) !=</span> <span class="hl kwa">null</span> ? _ref1 <span class="hl opt">:</span> <span class="hl kwa">new</span> <span class="hl kwd">StringOutput</span><span class="hl opt">();</span>
    <span class="hl kwa">if</span> <span class="hl opt">((</span>_ref2 <span class="hl opt">=</span> options<span class="hl opt">.</span>converter<span class="hl opt">) ==</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      options<span class="hl opt">.</span>converter <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Converter</span><span class="hl opt">(</span>options<span class="hl opt">);</span>
    <span class="hl opt">}</span>
    options<span class="hl opt">.</span>converter<span class="hl opt">.</span><span class="hl kwd">document</span><span class="hl opt">(</span>document<span class="hl opt">,</span> output<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>cb <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">) {</span>
      <span class="hl kwa">return</span> <span class="hl kwd">cb</span><span class="hl opt">(</span><span class="hl kwa">null</span><span class="hl opt">,</span> output<span class="hl opt">.</span><span class="hl kwd">final</span><span class="hl opt">());</span>
    <span class="hl opt">}</span>
  <span class="hl opt">};</span>

<span class="hl opt">}).</span><span class="hl kwd">call</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 3.9, http://www.andre-simon.de/-->